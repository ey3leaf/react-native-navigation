name: Test from github actions

on:
  pull_request:
    # paths-ignore:
      # - '!.github/workflows/**'
      # - '!.github/CODEOWNERS'
      # - '!package.json'
      # - '!.buildkite/pipeline.yml'


jobs:
    test-job:
      name: "PR gatekeeper"
      runs-on: ubuntu-latest
      steps:
      
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # OR "2" -> To retrieve the preceding commit.

      # Example 1
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v35.1.0

      - name: Save if result
        id: tof
        if: ${{ !contains(steps.changed-files.outputs.all_changed_files, 'package.json') || contains(steps.changed-files.outputs.all_changed_files, '.github/workflows') || !contains(steps.changed-files.outputs.all_changed_files, 'pipeline.yml') }} 
      
      - name: List all changed files
    
        run: |
          echo ${{ contains(steps.changed-files.outputs.all_changed_files, 'package.json') || contains(steps.changed-files.outputs.all_changed_files, '.github/workflows') || contains(steps.changed-files.outputs.all_changed_files, 'pipeline.yml') }}
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "$file was changed"
          done

      - name: Trigger Buildkite Pipeline
        if: ${{ steps.tof }} #${{ !contains(steps.changed-files.outputs.all_changed_files, 'package.json') || contains(steps.changed-files.outputs.all_changed_files, '.github/workflows') || !contains(steps.changed-files.outputs.all_changed_files, 'pipeline.yml') }}
        uses: buildkite/trigger-pipeline-action@v1.2.0
        env:
          BUILDKITE_API_ACCESS_TOKEN: ${{ secrets.BUILDKITE_TOKEN }}
          BRANCH: ${GITHUB_REF}
          PIPELINE: 'wix-mobile-oss/test-project'
